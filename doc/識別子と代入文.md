# 識別子と代入文

luaの変数宣言は、

- 初期値を書かないとnilになる(undefinedはない)
- 多値代入が自然`a, b = 1, 2`
  関数からの多値返しが自然に書けます
  順序は右辺を全て計算し終えてから代入が起こります(代入した変数を参照したい場合は２文(２行)にする必要がある)
- localを書かないとglobal変数になってしまう。(が、他言語のvar/letなどの代わりにlocalを書くと思えばそう面倒ではない)
- nilを代入すると(GCがそのうち)回収する。

yueでは、

- [yue] Unicode識別子が使えます。
  - luaでは5.2から使えなくなっていたUnicode識別子が使えます。(luajitは5.1なので今でも使えます)
  - 他言語では識別子に使えないマルチバイト文字などがありますが、多分全部使えます。
  - 識別子は連想配列のキーなので`['識別子']`とすれば使えてはいた。
  - rootブロックのUnicode識別子は変換されるため`_G['識別子']`とは別物になる(現状はlua5.1でも)
  - 狭い範囲で`π=math.pi`や`度=math.rad`とか使う？
- テーブル/クラスの中では`=`の替わりに`: `を使う必要がある(コロンは左に付ける必要がある)
- [yue] 多重代入があります `a = b = 0` (多値代入もあるので混乱すると思い私は使わってないです)
- 分解代入

  - テーブル(配列・辞書・その他)を崩して変数に代入できる機能
    様々なところで分解代入は使える(for文のループ変数、内包表記、関数戻り値、import にも分解して代入する記述が有る)
  - 分解代入を使うとき(分解しない)全体を受け取る方法はない
  - 分解代入に初期値をかける(整形が不十分なデータを整形済みのように扱える)
    右辺に含まれないキーもその場で作ってしまうことができる(例:2048 で、autosave に anim が含まれないが、`anim: @anim = {}`と書けば、作れる)
  - import文が分解代入のようなことをしているが、分解代入との表記の統一感が無い。(moonscriptからの継続性か？こちらが先にあった)

- 変数宣言がlocalが初期値になったのでlocalを省略できます(書くことも出来ます)。弊害もあります。
  他には

  - globalで`_G`に付ける
  - exportでモジュールの外側に見せる

  > [!warning]
  > yueでは変数はlocalが基本となったためlocalと書かなくて良くなったが、
  > その結果、変数を宣言して初期値を代入しているのか、外側の変数に再代入をしているのか区別がつきにくくなった。(特にコピペ移植で)
  > 元がluaのソースコードならばluacheckを掛けてshadowingしていないかチェックしながらyueに変換していく必要がある。
  > localと書くこともできるのでlocalを残しておけばいいが、ifの条件文のところで変数を宣言する場合などではlocalと書けない。
  > 多値の変数宣言のうち一つがこれに当たるなんてこともある。

- `_`(変数名)は捨てるものの代入に使うが、(有効な変数名なので)その後参照しないように注意
  luacheckが宣言しても参照しない変数(ループ変数など)をwarningで知らせてくるのでこれに置き換えている。
  これは、yue/luaでは有効な変数名なので参照できてしまう
  本当はしてはいけないが、 完全に理解している狭い間なら参照しても…(tamaleのルールで`{V"_", V"_"}`とすると結果として取れる)
  これを参照してもluacheckは何も言わない。(shadowingも)
  パイプのプレイスホルダは別物。変数名が作られる

- lua5.4でなくても使えるconstがある(静的チェックされる)
  しかし、テーブル/クラスの内容を変更することは出来てしまう
  GCから外れるわけではない(luajitにその機能がないため)
- lua5.4でなくても使えるcloseがある(ブロックを抜ける時実行されるものを書く機能。RAIIやscopeオブジェクト)
- 複合代入文(+=/or=/..=)がある(再代入だけど)

# データの種類

Luaにはのオブジェクトの種類は最小限です。
それはyueも代わりません。クラスもテーブルとメタテーブルを使って作られます。

| 種類       | 生成子(リテラル)                       | type()の戻り値         | 備考                                                          |
| ---------- | -------------------------------------- | ---------------------- | ------------------------------------------------------------- |
| nil        | `nil`                                  | 'nil'                  | undefinedはない。                                             |
| boolean    | `true`,`false`                         | 'bool'                 | pythonでtrueが1になっている場合直す必要がある                 |
| 数値(実数) | `1.0`など                              | 'number'               | 整数は無いものとみなす。                                      |
| 文字列     | `'abc'` `"あいう"`<br>`[[複数行]]`など | 'string'               | [yue]ではダブルクォート文字列が複数行もテンプレートもできる。 |
| テーブル   | `[1,2,3]` `{a: 1, b: 2, c: 3}`など     | 'table'                | [yue]では配列をカリーで書くこともできる                       |
| 関数       | `(a,b)->a..b`                          | 'function'             |
| コルーチン | coroutine.createで作る                 | 'thread'               |
| 多値       | カンマで区切って並べると多値           | 取れない               |
| (その他)   |                                        | 'userdata' 'cdata'など |

## nil、boolは省略

## 数値

<!-- - [lua] 単項+はない。 -->
<!-- - [lua] 先頭に0が並んでいてもOK。 -->
<!-- - [lua] １０進数、１６進数のみある。２進数、８進数はない(→tonumnber('1111',2)とする) -->
<!--   luajitではtonumber('nan') / tonumber('inf') / tonumber('-inf')も可能 -->
<!-- - [yue] 数値にアンダースコアを挟めるようになった -->
<!-- - .5 や 1.という表現はできる(luajitのみか？playground で 1.はできない？/lua5.4でもだめか？) -->
<!-- - [lua] eを使った指数表現、p を使った 16 進実数表記ある -->
<!-- - LL ULL 接尾辞はyueをパスする。I接尾辞は未対応 -->

```yuecode.lua
-- a = +1.0 -- [lua] 単項+はない。
b = 00123 -- [lua] 先頭に0が並んでいてもOK。
-- c, d = 0b1111, 0o7 -- [lua] １０進数、１６進数飲みある。２進数、８進数はない(→tonumnber('1111',2)とする)
                      --  luajitではtonumber('nan') / tonumber('inf') / tonumber('-inf')も可能
e = 1_000_000 -- [yue] 数値にアンダースコアを挟めるようになった
f1, f2 = .5, 1. -- .5 や 1.という表現はできる(luajitのみか？playground で 1.はできない？/lua5.4でもだめか？)
-- [lua] eを使った指数表現、p を使った 16 進実数表記ある
g = 1ULL -- LL ULL 接尾辞はyueをパスする。I接尾辞は未対応
type g -> 'cdata'
```

### numberは実数なので整数は無いものとみなす

言語としての統一感としては整数はないと考える
bitライブラリあるようなものは基本使わないことにする。
ビット演算、シフト演算などは覚えなくて良い。
整数を使った高速化の誘惑に駆られない。
一方で整数除算やmath.maxintegerは(整数が無いのに実装されていたら不自然だとは思うが、)あったほうが便利なのでlumeに追加した

### 文字列と数値の変換

luaは文字列と数値の自動変換がある
が`arr[1]!=arr['1']`です。

| 関数名                   | 戻り値        | 説明             | 備考           |
| ------------------------ | ------------- | ---------------- | -------------- |
| tonumber(str, base = 10) | number or nil | 基数に基づく変換 |
| format()                 | string        |                  | 引数はラジアン |

<!-- ### 気をつけることがある関数 -->
<!--  -->
<!-- lumeにclampやangleなど便利関数がある。 -->
<!--  -->
<!-- | 関数名                        | 戻り値      | 説明     | 備考                               | -->
<!-- | ----------------------------- | ----------- | -------- | ---------------------------------- | -->
<!-- | a^b                           | number      | 累乗     | ^0.5で平方根(速い)                 | -->
<!-- | math.min/max(x1,...)          | number      |          | 引数は１個以上何個でもいい         | -->
<!-- | lume.lerp(a, b, amount)       | number      | 線形補間 | linear interpolationの略           | -->
<!-- | lume.vector(angle, magnitude) | x,y         |          | 戻り値が多値なので{}で囲む         | -->
<!-- | math.random()                 | [0,1)       |          | 同じ関数でも与える引数で動作が違う | -->
<!-- | math.random([m,]n)            | [m,n]の整数 |          | lume.random(m,n)は実数を返す       | -->
<!--  -->
<!-- その他にも配列から一つ選ぶlume.randomchoice(arr)やvalの重み付けでkeyを選ぶweightedchoice(dict)がある。 -->

## 文字列

luaでの文字列は

- 文字のエンコードは関知しない
- luaでは文字列は文字の配列ではない。
  一文字を表す文字型はない。(空文字列も一文字も文字列)
  添字でn文字目にアクセスできたりはしない。→スライスを得るのにsub関数を使う
- 文字列はflyweightで管理され、同じ文字列は同じアドレス。これによって`==`と`!=`はアドレス比較で内容が同じか調べられる。
- 文字列は作られるとmetatable.indexにstringライブラリをセットされる。これによってオブジェクト指向風の呼び出しができる
- 文字列の比較は`==`、`~=`(yueでは`!=`でも可)、`<`、`<=`など、連結は`..`を使う。

> [!warning] str[n]が別機能
> `str\sub()`という呼び出し方ができるこの機能のためにメタテーブルが付けられるので
> 多言語でよく見る`str[n]`という表記を塞ぐことも出来ず、型がないのでluacheckもチェックできない。
> 多言語からのコピペ移植のときは[注意]

リテラルは

- シングルクォート文字列
- ダブルクォート文字列
- ダブルカリー文字列(複数行可、ヒアドキュメント？、先頭と末尾の改行は除去される)

yueでは、

ダブルクォート文字列が複数行にも対応するようになった上、式を埋め込むこともできる様になった。(テンプレート)

### 多言語のいくつかの型を文字列で代用する

- 正規表現のパターン(luaはフルの正規表現ではないので正規表現とは呼ばない)
- ファイルパス
- 日付と時刻
- Enumの各エントリー(しかし、それをまとめたものは無い)
- バイト配列(`\0`も含むことができる)

### utf8ライブラリ

lua5.3以上にはutf8ライブラリがある(Love2Dにもある。luajitの場合は互換ライブラリをluarocksで入れて使う)
一文字ずつ処理するcodesなど

### 気をつけることがある関数

| 関数名 | 戻り値 | 説明 | 備考               |
| ------ | ------ | ---- | ------------------ |
| a^b    | number | 累乗 | ^0.5で平方根(速い) |

### lpegライブラリ
