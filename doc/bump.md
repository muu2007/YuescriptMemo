# bump.lua

AABB衝突検知ライブラリ

- worldにadd(登録)remove(解除)してmove(動かす)。
  moveの戻り値に衝突情報が帰ってくる。
  moveにfilterを指定すると、標準の`"slide"`以外に、`nil/false`(検出しない)、`"cross"`(検出だけするが素通りする)などとできる
  常に重力落下させてbounceを指定するとガタガタな移動になる。→60fpsなのでbounceするものでもslideでやるべきか？
- `\update`はテレポート
- moveではcols(衝突情報)から色々するが、そのループの中でremove(消去)はできないので(追加はできる)一旦y=257にし、ループの外でremoveする。
  このときupdate(x, 257)もしなければならない(moveでの移動では床を抜けられないので)
  また、双方をy=257に移動させると、そこでも再度ぶつかりが検出されるので、collisionfilterにy<256を付けておく
- updateでw,hを変えることができる(スーパーマリオのしゃがみに使った)
- `queryRect`はマリオの足元を調べるときに使った。
- [注意] moveを呼んでも、動かないと衝突が取れない。(以前と同じ座標を指定するという意味)→checkを使うそうだ。
  例: playerと敵キャラがいて両方動く場合、`player\move`と`敵\move`に同じことを２回書かなければならない→当てられた方にまとめた。
  動かないオブジェクトは動く方からだけ検出できる。
- [注意] 戻り値のx, yはslideやcrossの場合、当たった場所ではなくその後滑った、過ぎ去った場所であることに注意
  当たった場所は`col.touch`である。
- col情報はitem/other/itemRect/otherRectのほかに
  move
  normal
  overlaps
  ti
  touch
  type = cross
  がある。
  自分の出したファイアーボールでダメージを受けないために体から離れてゆくものからはダメージを受けないこととした。
- world\addが何も返さないので、Charactorクラスの方でもw hを持つことになる(まだはcol情報を持ち回る。)

## 挟まれたときにワープしてしまうことへの対策

- 挟まれるなどして'slide'のものに重なると上か右にワープしてしまう。
  ワープしたか`old_x, old_y`との距離で判別して、もとの位置に戻して右に１ドット移動することにする。(スーパーマリオ1-2で起こる現象)
- Lift及び雲ブロックで発生する。
  Liftを動かすときに上にPlayerが乗っているかチェックして乗っていればPlayerもyとworld\updateで動かす。
  これをしないとすり抜けで落下してしまう。
- 雲ブロックでPlayerが横のブロックで進めない時、これだけでは重なってワープ対策として落ちてしまう。
  重なりが浅い時、戻す現象を起こさないと行けない。(が、左に戻しては右に進ませるものとバッティングしてしまうだろう)
  →横移動だけ、updateをmoveにしておく。
- updateでテレポートさせたり、Boxを大きくしたりすると、そのことが起因となる新たなグリッチ現象が増えてしまうため、
  このような策は最小限にするべき。

## スーパーマリオの挙動

- 一時停止アニメがあるので、frame countは使えない、全てtimeで行う。
- BダッシュからBボタンを離した時、徐々に通常の最高速度に下げる。
- ぬるっと真上のブロックに登れる。
  頭突きをするときに端っこであればxを調整(warpさせる)
- Bダッシュ中は隙間に落ちない
  足元ブロックを幅１８で調べることによって隙間であっても地面に接していることにする。
  マリオ自体の幅を16にしたら幅を増やすときに壁抜けするようになったのでダメ。
